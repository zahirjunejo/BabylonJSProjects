<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

        <title>Babylon.js Ocean Rider</title>
        <!-- Babylon.js -->
		
        <script src="http://code.jquery.com/pep/0.4.0/pep.min.js"></script>
        <script src="../../Babylon.js-2.4.0/dist/babylon.2.4.js"></script>
		<script src="../../Babylon.js-2.4.0/materialsLibrary/dist/babylon.waterMaterial.js"></script>
		<script src="../../Babylon.js-2.4.0/materialsLibrary/dist/babylon.skyMaterial.js"></script>
		<style>
            html, body {
                overflow: hidden;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #renderCanvas {
                width: 100%;
                height: 100%;
                touch-action: none;
            }
        </style>
    </head>
<body>
    <canvas id="renderCanvas"></canvas>

    <script>
	
        let canvas = document.getElementById("renderCanvas");
        let engine = new BABYLON.Engine(canvas, true);
        
        let createScene = () => {
            let scene = new BABYLON.Scene(engine);
			//scene.enablePhysics(null, new BABYLON.OimoJSPlugin());
			scene.enableCollisions = true;
			
            //Adding a light
            let sun = new BABYLON.PointLight("Omni", new BABYLON.Vector3(0, 1000, 0), scene);
        
            //Setup camera
            let camera = new BABYLON.ArcRotateCamera("FollowCam", 0, 0, 0, new BABYLON.Vector3(0, 0, 0), scene);
			
		        //Skybox
				let skybox = BABYLON.Mesh.CreateSphere("skybox", 10, 4000, scene);
				let skyMaterial = new BABYLON.SkyMaterial("skyMaterial",scene);
				skyMaterial.backFaceCulling = false;
				skybox.material = skyMaterial;
				skyMaterial.luminance = 0.1;
				skyMaterial.rayleigh = 0;
				skyMaterial.useSunPosition = true;
				skyMaterial.sunPosition = sun.position;
		        
				
				//Ground
				let ground = BABYLON.Mesh.CreateGround("islands",5000, 5000, 1, scene, false);
				let groundMaterial = new BABYLON.StandardMaterial("islands", scene);
				groundMaterial.diffuseTexture = new BABYLON.Texture("assets/textures/islandTexture.jpg", scene);
				groundMaterial.diffuseTexture.uScale = groundMaterial.diffuseTexture.vScale = 500;
				ground.position.y = -2.05;
				ground.material = groundMaterial;
			   
				
			    // Boat
                let boat = new BABYLON.AbstractMesh("speedboat", scene);
			    let boatSpeed = 1;
				let boatDirection = 0;
				
				BABYLON.SceneLoader.ImportMesh("", "assets/", "speedboat.babylon", scene,  (meshes, particleSystems) => { 
				
				meshes[0].rotation.x = Math.PI / 2;
				meshes[0].getScene().getMaterialByID("speedboat.Body").diffuseColor = new BABYLON.Color3(1.0,0.0,0.0);
				meshes[0].getScene().getMaterialByID("speedboat.Top").diffuseColor = new BABYLON.Color3(0.0, 0.0, 0.0);
				boat = meshes[0];
				
				camera.setPosition(new BABYLON.Vector3(1, 5, 15));
				
				
                boat.position = new BABYLON.Vector3(0, 0, 0);
                camera.setTarget(boat.position);				
				});
							   
                
			    		
		   //Water
		   let water = BABYLON.Mesh.CreateGround("water", 5000, 5000, 1, scene);
		   let waterMaterial = new BABYLON.WaterMaterial("water_material", scene);
		   waterMaterial.bumpTexture = new BABYLON.Texture("assets/textures/waterBump.png", scene);
		   waterMaterial.addToRenderList(skybox);
		   waterMaterial.addToRenderList(ground); 
		   waterMaterial.addToRenderList(boat);	   
		   water.material = waterMaterial;
	       waterMaterial.windForce = 0.5;
		  
		  let turnLeft, turnRight;
		  turnLeft = turnRight = false;
		  
		  const KEY_LEFT = 37;
		  const KEY_RIGHT = 39;
		  
		  window.addEventListener("keydown",(evt)=>{
		  if(!scene)
		  return;
		  
		  if(evt.keyCode == KEY_LEFT){
		  turnLeft = true;
		  turnRight = false; 
		  }
		  
		  if(evt.keyCode == KEY_RIGHT){
		  turnRight = true;
		  turnLeft = false;
		  
		  }
		  
		
		  });
		  
          window.addEventListener("keyup",(evt)=>{
		  turnLeft = turnRight = false;
		  });
		  
		  
		   
		   
		   scene.registerBeforeRender(()=>{
		   
			camera.setTarget(boat.position);
			camera.alpha = boatDirection;
			
			boat.position.y = 2.0;
			
			let xVel =  - boatSpeed * Math.cos(boatDirection);
			let zVel = - boatSpeed * Math.sin(boatDirection);
            
			boat.position.x += xVel;
			boat.position.z += zVel;
			
		
			
			if(turnRight == true){
			boat.rotation.z += - 0.01;
			boatDirection += boat.rotation.z;
			}
			
			if(turnLeft == true){
			boat.rotation.z +=  0.01;
			boatDirection += boat.rotation.z;
			}
			
			
			
		   });
  	   
            return scene;
        };
        
		let mainScene = createScene();
       
        engine.runRenderLoop(function () {
            mainScene.render();
        });

        // Resize
        window.addEventListener("resize", function () {
            engine.resize();
        });
		
    </script>
</body>
</html>
